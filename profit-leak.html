<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=0"/>
<title>Vizbix ‚Äì Profit Intelligence</title>

<script src="https://checkout.razorpay.com/v1/checkout.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <link rel="icon" type="image/png" href="favicon.png">
  <link rel="apple-touch-icon" href="favicon.png">

<style>
:root {
  --bg: #F8FAFC;
  --surface: #FFFFFF;
  --primary: #0F172A; 
  --accent: #3B82F6; 
  --accent-glow: rgba(59, 130, 246, 0.15);
  --success: #10B981;
  --text-main: #1E293B;
  --text-muted: #64748B;
  --border: #E2E8F0;
  --radius: 16px;
  --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
  --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
}

* { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }

body {
  margin: 0;
  background-color: var(--bg);
  background-image: 
    radial-gradient(at 0% 0%, hsla(253,16%,7%,0) 0, transparent 50%), 
    radial-gradient(at 50% 0%, hsla(225,39%,30%,0.05) 0, transparent 50%), 
    radial-gradient(at 100% 0%, hsla(339,49%,30%,0) 0, transparent 50%);
  font-family: 'Plus Jakarta Sans', system-ui, sans-serif;
  color: var(--text-main);
  padding-bottom: 60px;
}

main { max-width: 900px; margin: auto; padding: 20px; }

/* --- HEADER STYLES --- */
header {
  display: flex; justify-content: space-between; align-items: center;
  margin-bottom: 30px; padding-bottom: 16px; border-bottom: 1px solid var(--border);
  position: relative; z-index: 50; height: 70px;
}
.brand { font-size: 22px; font-weight: 800; letter-spacing: -0.5px; color: var(--primary); }
.brand span { color: var(--accent); }
.subtitle { font-size: 13px; color: var(--text-muted); font-weight: 500; display: block; margin-top: 2px;}
.header-actions { display: flex; gap: 8px; align-items: center; }

@media(max-width: 768px){
    .subtitle { display: none !important; }
    .btn-text-desktop { display: none !important; }
    .header-email-display { display: none !important; } 
    .header-actions { gap: 6px; }
    .brand { font-size: 20px; }
}

/* --- MENU DRAWER --- */
.menu-btn {
  width: 40px; height: 40px; border: 1px solid rgba(229,231,235,0.9);
  background: #fff; border-radius: 12px; display: flex; align-items: center; justify-content: center;
  cursor: pointer; box-shadow: 0 2px 5px rgba(2, 6, 23, 0.05); padding: 0; flex-shrink: 0;
}
.menu-btn:active { transform: scale(0.96); }
.menu-icon { width: 16px; height: 12px; position: relative; }
.menu-icon span { position: absolute; left: 0; right: 0; height: 2px; background: var(--text-main); border-radius: 10px; }
.menu-icon span:nth-child(1) { top: 0; }
.menu-icon span:nth-child(2) { top: 5px; opacity: 0.9; }
.menu-icon span:nth-child(3) { bottom: 0; }

.drawer-overlay { position: fixed; inset: 0; background: rgba(2,6,23,0.55); opacity: 0; pointer-events: none; transition: opacity .2s ease; z-index: 150; }
.drawer { position: fixed; top: 0; right: 0; height: 100%; width: min(300px, 85vw); background: #fff; border-left: 1px solid var(--border); box-shadow: -10px 0 30px rgba(2,6,23,.14); transform: translateX(105%); transition: transform .25s ease; z-index: 160; display: flex; flex-direction: column; }
.drawer.open { transform: translateX(0); }
.drawer-overlay.open { opacity: 1; pointer-events: auto; }
.drawer-head { padding: 16px; border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; }
.drawer-title { font-weight: 900; font-size: 16px; color: var(--primary); }
.drawer-close { width: 36px; height: 36px; border-radius: 10px; border: 1px solid var(--border); background: #fff; cursor: pointer; display: flex; align-items: center; justify-content: center; padding: 0;}
.drawer-close svg { width: 18px; height: 18px; stroke: var(--text-main); }
.drawer-body { padding: 16px; overflow: auto; }
.drawer-profile { background: #EFF6FF; border: 1px solid #DBEAFE; padding: 12px; border-radius: 12px; margin-bottom: 16px; }
.drawer-profile-label { font-size: 11px; font-weight: 700; color: #64748B; text-transform: uppercase; margin-bottom: 4px; }
.drawer-profile-email { font-size: 13px; font-weight: 600; color: #1E40AF; word-break: break-all; }
.drawer-links { display: flex; flex-direction: column; gap: 8px; }
.drawer-links a { text-decoration: none; color: var(--text-main); border: 1px solid var(--border); background: #fff; padding: 12px; border-radius: 12px; display: flex; align-items: center; justify-content: space-between; font-weight: 600; font-size: 14px; }
.drawer-links a:hover { background: #F8FAFC; }
.drawer-mini { margin-top: 20px; padding-top: 14px; border-top: 1px solid var(--border); color: var(--text-muted); font-size: 12px; line-height: 1.5; }

/* --- Cards & Layout --- */
.card { background: var(--surface); border-radius: var(--radius); padding: 24px; margin-bottom: 24px; box-shadow: var(--shadow-sm); border: 1px solid var(--border); transition: transform 0.2s ease, box-shadow 0.2s ease; }

/* --- Inputs & Grid --- */
.input-group { position: relative; margin-bottom: 20px; }
.input-label { display: block; font-size: 12px; font-weight: 700; color: var(--text-muted); margin-bottom: 6px; text-transform: uppercase; letter-spacing: 0.5px; }

input { width: 100%; padding: 12px 14px; border-radius: 10px; border: 1px solid var(--border); background: #F1F5F9; font-weight: 500; transition: all 0.2s; font-size: 14px; }
input:focus { background: #fff; border-color: var(--accent); box-shadow: 0 0 0 4px var(--accent-glow); }

.grid-header { display: grid; grid-template-columns: 2fr 1fr 1fr 1fr 40px; gap: 10px; padding: 0 10px 8px 10px; font-size: 11px; font-weight: 600; color: var(--text-muted); }
.grid-row { display: grid; grid-template-columns: 2fr 1fr 1fr 1fr 40px; gap: 10px; margin-bottom: 10px; align-items: center; }

@media(max-width:640px){
  .grid-header { display: none; }
  .grid-row { grid-template-columns: 1fr 1fr; gap: 8px; background: #fff; padding: 12px; border-radius: 12px; border: 1px solid var(--border); box-shadow: 0 1px 2px rgba(0,0,0,0.02); }
  .grid-row input:first-child { grid-column: span 2; }
}

/* --- Buttons --- */
button { padding: 10px 16px; border-radius: 12px; font-weight: 600; font-size: 13px; cursor: pointer; border: none; transition: all 0.2s; display: inline-flex; align-items: center; justify-content: center; gap: 6px; white-space: nowrap; }
.btn-primary { background: var(--primary); color: white; box-shadow: 0 4px 12px rgba(15, 23, 42, 0.2); }
.btn-secondary { background: white; border: 1px solid var(--border); color: var(--text-main); }
.btn-ghost { background: transparent; color: var(--text-muted); padding: 8px; }

/* --- Results Section --- */
.kpi-container { display: flex; gap: 12px; margin-bottom: 24px; flex-wrap: wrap; }
.kpi-card { flex: 1; background: linear-gradient(135deg, #f8fafc 0%, #ffffff 100%); border: 1px solid var(--border); border-radius: 12px; padding: 14px; min-width: 130px; }
.kpi-label { font-size: 11px; font-weight: 700; color: var(--text-muted); margin-bottom: 4px; }
.kpi-value { font-size: 20px; font-weight: 800; color: var(--primary); white-space: nowrap; }

/* --- NEW: TOGGLE SWITCH --- */
.mode-switch-container { display: flex; background: #F1F5F9; padding: 4px; border-radius: 12px; margin-bottom: 20px; border: 1px solid var(--border); }
.mode-btn { flex: 1; padding: 10px; border: none; background: transparent; font-weight: 600; font-size: 13px; color: var(--text-muted); cursor: pointer; border-radius: 10px; transition: all 0.2s ease; }
.mode-btn.active { background: white; color: var(--primary); box-shadow: 0 2px 5px rgba(0,0,0,0.05); }

/* --- NEW: MONTHLY INPUTS --- */
.monthly-inputs { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
@media(max-width: 600px) { .monthly-inputs { grid-template-columns: 1fr; } }

/* Info Box */
.info-box-small { background: #EFF6FF; border: 1px solid #DBEAFE; color: #1E40AF; padding: 10px 12px; border-radius: 10px; font-size: 12px; font-weight: 600; margin-bottom: 15px; display: flex; align-items: center; gap: 8px; }

/* --- Locked Content --- */
.locked-container { position: relative; overflow: hidden; }
.blur-overlay { position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(255, 255, 255, 0.2); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); z-index: 10; display: flex; flex-direction: column; align-items: center; justify-content: center; border-radius: var(--radius); border: 1px solid rgba(255,255,255,0.5); }
.lock-card { background: white; padding: 24px; border-radius: 20px; text-align: center; box-shadow: 0 20px 40px rgba(0,0,0,0.1); border: 1px solid var(--border); max-width: 320px; width: 90%; }
.premium-badge { background: linear-gradient(135deg, #0F172A 0%, #334155 100%); color: white; padding: 4px 12px; border-radius: 20px; font-size: 10px; font-weight: 700; text-transform: uppercase; margin-bottom: 12px; display: inline-block; }
.feature-list { text-align: left; margin: 15px 0 20px; padding: 0 10px; font-size: 13px; color: var(--text-muted); display: inline-block; }
.feature-list div { margin-bottom: 6px; display: flex; align-items: center; gap: 8px; }

/* --- Featured Tool Card --- */
.pro-card { background: linear-gradient(135deg, #0F172A 0%, #1E293B 100%); border-radius: 20px; padding: 24px; color: white; text-decoration: none; display: flex; align-items: center; justify-content: space-between; gap: 20px; box-shadow: 0 20px 40px -10px rgba(15, 23, 42, 0.3); transition: transform 0.2s ease; position: relative; overflow: hidden; margin-bottom: 40px; }
.pro-card:hover { transform: translateY(-3px); }
.pro-badge { background: rgba(59, 130, 246, 0.2); color: #60A5FA; font-size: 11px; font-weight: 800; padding: 4px 10px; border-radius: 20px; border: 1px solid rgba(59, 130, 246, 0.4); display: inline-block; margin-bottom: 8px; }
.pro-content h3 { margin: 0 0 6px; font-size: 18px; color: white; letter-spacing: -0.01em; }
.pro-content p { margin: 0; color: #94A3B8; font-size: 14px; line-height: 1.5; max-width: 500px; }
.pro-icon { width: 48px; height: 48px; background: rgba(255,255,255,0.1); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 20px; flex-shrink: 0; color: white; }
@media (max-width: 520px){ .pro-card { flex-direction: column; align-items: flex-start; } .pro-icon { display: none; } }

/* --- History Modal --- */
.modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(15, 23, 42, 0.6); backdrop-filter: blur(4px); z-index: 100; display: none; align-items: center; justify-content: center; }
.modal-content { background: white; width: 90%; max-width: 500px; border-radius: 16px; padding: 24px; max-height: 80vh; overflow-y: auto; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25); }
.history-item { display: flex; justify-content: space-between; align-items: center; padding: 12px; border-bottom: 1px solid var(--border); cursor: pointer; }
.history-item:hover { background: #F8FAFC; }

/* --- Insights & AI --- */
.insight-item { display: flex; align-items: start; gap: 12px; padding: 14px; border-radius: 12px; margin-bottom: 10px; font-size: 13px; line-height: 1.5; }
.insight-green { background: #ECFDF5; color: #065F46; border: 1px solid #D1FAE5; }
.insight-blue { background: #EFF6FF; color: #1E40AF; border: 1px solid #DBEAFE; }
.insight-orange { background: #FFF7ED; color: #9A3412; border: 1px solid #FFEDD5; }
.insight-gray { background: #F8FAFC; color: #475569; border: 1px solid #E2E8F0; }
.ai-thinking { background: linear-gradient(90deg, #eff6ff 0%, #dbeafe 50%, #eff6ff 100%); background-size: 200% 100%; animation: shimmer 1.5s infinite; color: #1E40AF !important; cursor: wait; }
@keyframes shimmer { 0% {background-position: 100% 0} 100% {background-position: -100% 0} }

table { width: 100%; border-collapse: separate; border-spacing: 0; margin-top: 20px; }
th { text-align: left; padding: 12px; border-bottom: 2px solid var(--border); font-size: 12px; color: var(--text-muted); }
td { padding: 12px; border-bottom: 1px solid var(--border); font-size: 14px; }

</style>
</head>

<body>

<div class="modal-overlay" id="historyModal">
  <div class="modal-content">
    <div style="display:flex; justify-content:space-between; margin-bottom:16px;">
      <h3 style="margin:0">Saved Analysis History</h3>
      <button class="btn-ghost" onclick="toggleHistory(false)">‚úï</button>
    </div>
    <div id="historyList">Loading...</div>
  </div>
</div>

<div class="drawer-overlay" id="drawerOverlay"></div>
<aside class="drawer" id="drawer">
  <div class="drawer-head">
    <div class="drawer-title">Menu</div>
    <button class="drawer-close" id="drawerClose"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 6L6 18"></path><path d="M6 6l12 12"></path></svg></button>
  </div>
  <div class="drawer-body">
    <div id="drawerProfile" class="drawer-profile" style="display:none;">
        <div class="drawer-profile-label">Signed in as</div>
        <div id="drawerEmailDisplay" class="drawer-profile-email"></div>
        <div id="drawerExpiryDisplay" style="font-size:11px; color:#64748B; margin-top:4px;"></div>
    </div>
    <div class="drawer-links">
      <a href="index.html">Home</a>
      <a href="#" onclick="closeDrawer(); toggleHistory(true); return false;">Saved History</a>
      <a href="profit-leak.html" style="background: #F0F9FF; border-color: #BAE6FD;">Profit Optimizer <span style="background:#0F172A; color:white; padding:2px 6px; border-radius:6px; font-size:10px;">NEW</span></a>
      <a href="free-tools.html">Other Tools</a>
      <a href="about.html">About Vizbix</a>
    </div>
    <div class="drawer-mini">Vizbix: Simple numbers ‚Üí clear decisions.</div>
  </div>
</aside>

<main>
  <header>
    <div><div class="brand">Vizbix<span>.</span></div><div class="subtitle">E-commerce Intelligence Engine</div></div>
    <div class="header-actions">
        <button id="historyBtn" class="btn-secondary" style="display:none;" onclick="toggleHistory(true)"><span style="font-size: 16px;">üìÇ</span><span class="btn-text-desktop">History</span></button>
        <button id="loginBtn" class="btn-primary" onclick="handleLoginClick()">Login</button>
        <div class="header-email-display" id="userEmailHeader" style="display:none; font-size:12px; font-weight:600; color:var(--primary); padding:6px 10px; background:white; border-radius:8px; border:1px solid var(--border);"></div>
        <button class="menu-btn" id="menuBtn"><div class="menu-icon"><span></span><span></span><span></span></div></button>
    </div>
  </header>

  <section>
      <div style="display:flex; align-items:flex-end; justify-content:space-between; margin-bottom:12px;">
          <h2 style="font-size:22px; margin:0;">Featured Tool</h2>
          <span style="font-size:13px; color:var(--text-muted);">AI-Powered</span>
      </div>
      <a href="profit-leak.html" class="pro-card">
          <div class="pro-content">
              <div class="pro-badge">‚ú® VIZBIX PRO</div>
              <h3>Profit Optimizer</h3>
              <p>The only tool that uses <strong>AI</strong> to analyze your margins, find hidden leaks, and suggest pricing strategies.</p>
          </div>
          <div class="pro-icon">‚ûî</div>
      </a>
  </section>

  <div class="card">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
      <div class="input-label">DATA SOURCE</div>
      <div class="input-label" style="color:var(--accent); cursor:pointer;" onclick="sample()">Use Demo Data</div>
    </div>
    
    <div class="mode-switch-container">
        <button class="mode-btn active" id="btnProduct" onclick="setMode('product')">Product Wise</button>
        <button class="mode-btn" id="btnMonthly" onclick="setMode('monthly')">Monthly Overview</button>
    </div>

    <div id="productInputs">
        <div class="grid-header">
          <div>PRODUCT NAME</div>
          <div>SELL PRICE</div>
          <div>COST PRICE</div>
          <div>QTY SOLD</div>
          <div></div>
        </div>
        <div id="items"></div>
        <button class="btn-secondary" onclick="addRow()" style="width:100%; margin-top:10px;">+ Add Product</button>
    </div>

    <div id="monthlyInputs" style="display:none;">
        <div class="info-box-small">
            <span style="font-size:16px;">üí°</span> 
            <div><strong>Pro Tip:</strong> Add 2‚Äì6 months of data for the most accurate trend analysis.</div>
        </div>
        <div class="grid-header">
            <div>MONTH (Optional)</div>
            <div>SALES (‚Çπ)</div>
            <div>EXPENSES (‚Çπ)</div>
            <div>ORDERS</div>
            <div></div>
        </div>
        <div id="monthItems"></div>
        <button class="btn-secondary" onclick="addMonthRow()" style="width:100%; margin-top:10px;">+ Add Month Data</button>
    </div>

    <div style="margin-top:16px; display:flex; gap:10px; align-items: stretch;">
      <button id="analyzeBtn" class="btn-primary" style="flex:2;" onclick="analyze()">Generate Report ‚Üí</button>
      <button id="saveCloudBtn" class="btn-secondary" style="display:none; width:50px; flex-shrink:0; padding:0; align-items:center; justify-content:center;" onclick="saveToCloud()" title="Save to Cloud"><span style="font-size:18px">üíæ</span></button>
    </div>
  </div>

  <div id="results" style="display:none">
    
    <div class="kpi-container">
      <div class="kpi-card">
        <div class="kpi-label" id="kpiRevLabel">TOTAL REVENUE</div>
        <div class="kpi-value" id="dispRevenue">‚Çπ0</div>
      </div>
      <div class="kpi-card">
        <div class="kpi-label" id="kpiCostLabel">TOTAL COST</div>
        <div class="kpi-value" id="dispCost" style="color:#64748B">‚Çπ0</div>
      </div>
      <div class="kpi-card" style="border-color:var(--success); background:#f0fdf4;">
        <div class="kpi-label" style="color:#15803d" id="kpiProfitLabel">NET PROFIT</div>
        <div class="kpi-value" id="dispProfit" style="color:#15803d">‚Çπ0</div>
      </div>
    </div>

    <div id="monthlyMetrics" class="kpi-container" style="display:none;">
        <div class="kpi-card" style="background:#EFF6FF; border-color:#DBEAFE">
            <div class="kpi-value" id="dispAOV">‚Çπ0</div>
            <div class="kpi-label" style="color:#1E40AF">Avg Order Value</div>
        </div>
        <div class="kpi-card" style="background:#EFF6FF; border-color:#DBEAFE">
            <div class="kpi-value" id="dispOrders">0</div>
            <div class="kpi-label" style="color:#1E40AF">Avg Monthly Orders</div>
        </div>
    </div>

    <div class="card locked-container" id="proContainer">
      <div class="blur-overlay" id="lockOverlay">
        <div class="lock-card">
          <span class="premium-badge">Vizbix Pro</span>
          <h3 style="margin:0 0 5px 0;">Unlock Strategic Insights</h3>
          
          <div class="feature-list">
              <div>‚úÖ <strong>AI Business Consultant</strong></div>
              <div>‚úÖ <strong>Unlimited Cloud History</strong></div>
              <div>‚úÖ <strong>Visual Charts & Graphs</strong></div>
              <div>‚úÖ <strong>PDF Report Export</strong></div>
          </div>

          <input id="emailInput" placeholder="Enter your email" style="margin-bottom:10px; text-align:center;">
          <button class="btn-primary" style="width:100%" onclick="pay()">Unlock for ‚Çπ299</button>
          <button style="background:none; border:none; color:#64748B; font-size:11px; margin-top:10px; cursor:pointer; text-decoration:underline" onclick="verify(null)">Restore Purchase</button>
        </div>
      </div>

      <div id="proContent">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
          <h3 style="margin:0">Strategic Report</h3>
          <button class="btn-secondary" style="padding:6px 12px; font-size:12px;" onclick="downloadPDF()">‚Üì Export Report</button>
        </div>

        <h3 style="margin-bottom:15px">Optimization Strategy</h3>
        <div id="insights"></div>

        <div id="tableContainer">
            <h3 style="margin-top:30px; margin-bottom:15px">Detailed Margin Analysis</h3>
            <div style="overflow-x:auto;">
              <table id="table"></table>
            </div>
        </div>

        <h3 style="margin-top:40px; margin-bottom:15px">Visual Breakdown</h3>
        <div style="height:300px; margin-bottom:30px; position: relative;">
          <canvas id="chart"></canvas>
        </div>
      </div>
    </div>
  </div>

</main>

<script>
// --- CONFIG ---
const workerURL = "https://vizbix-api.vizbixhq.workers.dev";
const PRICE = 29900;
const KEY = "rzp_live_SCvIqUMzTNsXgq"; 

// --- STATE ---
const items = document.getElementById("items");
const monthItems = document.getElementById("monthItems");
let chartInstance;
let currentData = [];
let monthlyStats = null; // Store stats for AI
let userEmail = localStorage.getItem("vizbix_email") || null;
let isProUser = false;
let currentMode = 'product'; // 'product' or 'monthly'

// --- INIT ---
Chart.register(ChartDataLabels); // Plugin for chart labels

window.addEventListener('DOMContentLoaded', () => {
    loadDrafts();
    if(userEmail) { verify(userEmail); }
});

// --- MODE SWITCHING (PREVENTS RESETTING REPORT) ---
function setMode(mode) {
    currentMode = mode;
    document.getElementById('btnProduct').className = mode === 'product' ? 'mode-btn active' : 'mode-btn';
    document.getElementById('btnMonthly').className = mode === 'monthly' ? 'mode-btn active' : 'mode-btn';
    document.getElementById('productInputs').style.display = mode === 'product' ? 'block' : 'none';
    document.getElementById('monthlyInputs').style.display = mode === 'monthly' ? 'block' : 'none';
    
    // Toggle Sample button
    document.querySelector(".input-label[onclick='sample()']").style.display = mode === 'product' ? 'block' : 'none';

    // SMART REPORT TOGGLE: Only show results if data exists for that mode
    const resultsDiv = document.getElementById('results');
    if (mode === 'monthly' && monthlyStats) {
        resultsDiv.style.display = 'block';
        analyzeMonthly(); // Refresh view
    } else if (mode === 'product' && currentData.length > 0) {
        resultsDiv.style.display = 'block';
        analyzeProduct(); // Refresh view
    } else {
        resultsDiv.style.display = 'none';
    }
}

// --- ROW MANAGEMENT ---
function createRow(container, name="", val1="", val2="", val3="", isMonth=false){
  const d = document.createElement("div");
  d.className = "grid-row";
  
  // Custom placeholders
  const p1 = isMonth ? "Month (e.g. Jan)" : "Product Name";
  const p2 = isMonth ? "Sales ‚Çπ" : "Sell Price";
  const p3 = isMonth ? "Expenses ‚Çπ" : "Cost Price";
  const p4 = isMonth ? "Orders" : "Quantity";

  d.innerHTML = `
    <input type="text" placeholder="${p1}" value="${name}">
    <input type="number" placeholder="${p2}" value="${val1}">
    <input type="number" placeholder="${p3}" value="${val2}">
    <input type="number" placeholder="${p4}" value="${val3}">
    <button class="btn-ghost" onclick="this.parentElement.remove(); saveDraft()">‚úï</button>
  `;
  container.appendChild(d);
}

function addRow(){ createRow(items); saveDraft(); }
function addMonthRow(){ createRow(monthItems, "", "", "", "", true); saveDraft(); }

// --- DRAFTS ---
function saveDraft() {
    const prodData = scrapeRows(items);
    const monthData = scrapeRows(monthItems);
    localStorage.setItem("vizbix_draft", JSON.stringify(prodData));
    localStorage.setItem("vizbix_draft_month", JSON.stringify(monthData));
}

function loadDrafts() {
    const prodSaved = JSON.parse(localStorage.getItem("vizbix_draft") || "[]");
    const monthSaved = JSON.parse(localStorage.getItem("vizbix_draft_month") || "[]");
    
    items.innerHTML = ""; monthItems.innerHTML = "";
    
    if(prodSaved.length > 0) prodSaved.forEach(x => createRow(items, x.n, x.v1, x.v2, x.v3));
    else { addRow(); addRow(); }
    
    if(monthSaved.length > 0) monthSaved.forEach(x => createRow(monthItems, x.n, x.v1, x.v2, x.v3, true));
    else { addMonthRow(); addMonthRow(); }
}

function scrapeRows(container) {
    let data = [];
    container.querySelectorAll(".grid-row").forEach(r => {
        const i = r.querySelectorAll("input");
        data.push({ n: i[0].value, v1: i[1].value, v2: i[2].value, v3: i[3].value });
    });
    return data;
}

function sample(){
  items.innerHTML="";
  [["Wireless Earbuds", 2500, 1200, 140], ["Smart Watch", 4500, 2800, 85], ["USB-C Cable", 499, 150, 400]].forEach(x => createRow(items, x[0], x[1], x[2], x[3]));
  saveDraft(); analyze();
}

// --- ANALYSIS MAIN ---
function analyze(){
    if(currentMode === 'monthly') analyzeMonthly();
    else analyzeProduct();
}

// --- MONTHLY ANALYSIS (Multi-Month Logic) ---
function analyzeMonthly() {
    let totalSales=0, totalExp=0, totalOrders=0, count=0;
    
    monthItems.querySelectorAll(".grid-row").forEach(r => {
        const i = r.querySelectorAll("input");
        const s = Number(i[1].value)||0, e = Number(i[2].value)||0, o = Number(i[3].value)||0;
        if(s>0 || e>0) { totalSales+=s; totalExp+=e; totalOrders+=o; count++; }
    });

    if(count === 0) return alert("Please enter data for at least one month.");

    // Averages
    const avgSales = totalSales / count;
    const avgExp = totalExp / count;
    const avgProfit = avgSales - avgExp;
    const avgOrders = totalOrders > 0 ? (totalOrders / count) : 0;
    const avgAOV = avgOrders > 0 ? (avgSales / avgOrders) : 0;
    const margin = avgSales > 0 ? (avgProfit / avgSales * 100) : 0;

    // Save for AI/Switching
    monthlyStats = { avgSales, avgExp, avgProfit, avgOrders, avgAOV, margin, count };

    // UI Updates
    showResults();
    document.getElementById("kpiRevLabel").innerText = "AVG MONTHLY SALES";
    document.getElementById("kpiCostLabel").innerText = "AVG MONTHLY EXPENSES";
    document.getElementById("kpiProfitLabel").innerText = "AVG MONTHLY PROFIT";
    document.getElementById("dispRevenue").innerText = "‚Çπ " + avgSales.toLocaleString(undefined, {maximumFractionDigits:0});
    document.getElementById("dispCost").innerText = "‚Çπ " + avgExp.toLocaleString(undefined, {maximumFractionDigits:0});
    document.getElementById("dispProfit").innerText = "‚Çπ " + avgProfit.toLocaleString(undefined, {maximumFractionDigits:0});
    
    document.getElementById("monthlyMetrics").style.display = "flex";
    document.getElementById("dispAOV").innerText = "‚Çπ " + avgAOV.toFixed(0);
    document.getElementById("dispOrders").innerText = avgOrders.toFixed(1);
    document.getElementById("tableContainer").style.display = "none";

    // Client-Style Insights (Formatted)
    generateMonthlyInsights(margin, avgOrders, avgAOV, count);
    
    // Pie Chart: Sales context (Blue) -> Expense (Orange) vs Profit (Green)
    drawChart('pie', ['Expenses', 'Net Profit'], [avgExp, avgProfit], ['#F97316', '#10B981']);
}

// --- REPLACEMENT FUNCTION: EXPANDED MONTHLY INSIGHTS ---
function generateMonthlyInsights(margin, orders, aov, count) {
    const div = document.getElementById("insights");
    let statusTitle = "";
    let statusColor = ""; // blue, green, orange, or red (custom class needed for red)
    let strategies = [];

    // --- LOGIC ENGINE: 5 SCENARIOS ---

    // Scenario 1: Losing Money (Negative Margin)
    if (margin <= 0) {
        statusTitle = "üö® CRITICAL: You are losing money on every sale.";
        statusColor = "insight-orange"; // Using orange as 'warning' style
        strategies = [
            `<strong>Stop Ads Immediately:</strong> You are burning cash. Pause all paid marketing until you fix your unit economics.`,
            `<strong>Price Audit:</strong> You need to raise prices by at least ${Math.abs(margin).toFixed(0)}% just to break even.`,
            `<strong>Cost Cutting:</strong> Negotiate with your supplier or switch to cheaper packaging immediately.`
        ];
    } 
    // Scenario 2: High Volume, Low Margin (The "Busy but Broke" Trap)
    else if (orders > 30 && margin < 15) {
        statusTitle = "‚ö† High Activity, Low Profit (The 'Busy Trap')";
        statusColor = "insight-orange";
        strategies = [
            `<strong>Price Hike Test:</strong> You have volume leverage. Increase prices by 5-10%. You might lose a few customers, but total profit will likely go <i>up</i>.`,
            `<strong>Kill Low-Margin Best Sellers:</strong> If your most popular item has low margin, it is dragging you down. Bundle it with a high-margin accessory.`,
            `<strong>Supplier Negotiation:</strong> Since you are ordering ${orders.toFixed(0)} times a month, demand a bulk discount from your vendor.`
        ];
    }
    // Scenario 3: High Margin, Low Volume (The "Hidden Gem")
    else if (margin > 25 && orders < 10) {
        statusTitle = "üíé Hidden Gem: Great Product, Needs Eyes";
        statusColor = "insight-blue";
        strategies = [
            `<strong>Aggressive Marketing:</strong> Your margins are healthy (${margin.toFixed(0)}%). You can afford to spend more on ads to acquire customers.`,
            `<strong>Collect Social Proof:</strong> Email your ${orders.toFixed(0)} past customers personally. Ask for a photo review in exchange for a discount code.`,
            `<strong>Micro-Influencers:</strong> Send free samples to small influencers. Your high margin covers the cost, and you need the visibility.`
        ];
    }
    // Scenario 4: Healthy & Stable (The "Optimizer")
    else if (margin >= 20 && orders >= 10) {
        statusTitle = "‚úÖ Healthy Business: Time to Maximize";
        statusColor = "insight-green";
        strategies = [
            `<strong>Increase AOV:</strong> Your flow is steady. Add a "One-Click Upsell" at checkout (e.g., a ‚Çπ299 accessory) to boost revenue by 15% without new customers.`,
            `<strong>Email Marketing:</strong> Don't just sell once. Send a "VIP Restock" or "New Arrival" email to your list this week.`,
            `<strong>Loyalty Loop:</strong> Insert a "Thank You" card with a 10% off coupon for their <i>next</i> order inside the box.`
        ];
    }
    // Scenario 5: The "Average" Trap (Middle ground)
    else {
        statusTitle = "‚öñÔ∏è Stable but Stagnant";
        statusColor = "insight-blue";
        strategies = [
            `<strong>Bundle Builder:</strong> Create a "Starter Kit" or "Gift Bundle" priced at ‚Çπ${(aov * 1.5).toFixed(0)}. This forces AOV up.`,
            `<strong>Shipping Threshold:</strong> Set "Free Shipping" at ‚Çπ${(aov + 200).toFixed(0)} to encourage adding one more small item.`,
            `<strong>Follow Up:</strong> Send a WhatsApp message 7 days after delivery asking "How was it?" to build trust for repeat sales.`
        ];
    }

    // --- HTML GENERATION ---
    div.innerHTML = `
        <div class="insight-item ${statusColor}">
            <div>
                <div style="font-size:14px; font-weight:800; margin-bottom:8px;">${statusTitle}</div>
                <div style="margin-bottom:12px;">Based on your average of <strong>${orders.toFixed(1)} orders/mo</strong> and <strong>${margin.toFixed(0)}% margin</strong>:</div>
                
                <ul style="margin:0; padding-left:18px; line-height:1.6;">
                    <li style="margin-bottom:6px;">${strategies[0]}</li>
                    <li style="margin-bottom:6px;">${strategies[1]}</li>
                    <li>${strategies[2]}</li>
                </ul>
            </div>
        </div>
        ${getAiButtonHtml()} 
    `;
}
// --- PRODUCT ANALYSIS ---
function analyzeProduct(){
  let data = []; let totalRevenue = 0, totalCost = 0, totalProfit = 0;
  items.querySelectorAll(".grid-row").forEach(r => {
    const i = r.querySelectorAll("input");
    const name=i[0].value||"Item", sell=+i[1].value||0, cost=+i[2].value||0, qty=+i[3].value||0;
    if(sell===0 && cost===0) return;
    const rev=sell*qty, pc=cost*qty, prof=rev-pc;
    totalRevenue+=rev; totalCost+=pc; totalProfit+=prof;
    data.push({name, sell, cost, qty, profit:prof, margin: sell>0?((sell-cost)/sell):0});
  });

  if(data.length===0) return alert("Please enter at least one product.");
  currentData = data; 
  showResults();
  
  document.getElementById("kpiRevLabel").innerText = "TOTAL REVENUE";
  document.getElementById("kpiCostLabel").innerText = "TOTAL COST";
  document.getElementById("kpiProfitLabel").innerText = "NET PROFIT";
  document.getElementById("monthlyMetrics").style.display = "none";
  document.getElementById("tableContainer").style.display = "block";

  document.getElementById("dispRevenue").innerText = "‚Çπ "+totalRevenue.toLocaleString();
  document.getElementById("dispCost").innerText = "‚Çπ "+totalCost.toLocaleString();
  document.getElementById("dispProfit").innerText = "‚Çπ "+totalProfit.toLocaleString();

  generateTable(data); generateInsights(data);
  drawChart('bar', data.map(x=>x.name), data.map(x=>x.profit), '#0F172A');
}

function showResults() {
    document.getElementById("results").style.display = "block";
    document.getElementById("results").scrollIntoView({behavior: "smooth"});
}

function generateInsights(d){
  const div = document.getElementById("insights"); let html = "", cnt = 0;
  const bestProfit = [...d].sort((a,b)=>b.profit - a.profit)[0];
  if(bestProfit) { html += `<div class="insight-item insight-green"><div><strong>‚òÖ Star Product:</strong> ${bestProfit.name} generates the most profit (‚Çπ${bestProfit.profit.toLocaleString()}). Focus ad spend here.</div></div>`; cnt++; }
  const bestQty = [...d].sort((a,b)=>b.qty - a.qty)[0];
  if(bestQty && bestQty.name !== bestProfit?.name) { html += `<div class="insight-item insight-blue"><div><strong>üì¶ Volume Leader:</strong> ${bestQty.name} is your most popular item (${bestQty.qty} units). Consider bundling it with slower items.</div></div>`; cnt++; }
  d.filter(x => x.margin < 0.20).forEach(x => { if(cnt < 4) { html += `<div class="insight-item insight-orange"><div><strong>‚ö† Low Margin:</strong> ${x.name} is only ${(x.margin*100).toFixed(0)}%. Raise price or lower cost to improve health.</div></div>`; cnt++; }});
  if(cnt < 3 && d.length > 0) html += `<div class="insight-item insight-gray"><div><strong>üí° Growth Tip:</strong> You have a healthy catalog. Consider testing a 10% price increase on your top sellers to boost net profit.</div></div>`;
  html += getAiButtonHtml();
  div.innerHTML = html;
}

function getAiButtonHtml() {
    return `<div id="aiContainer" style="margin-top:15px; border-top:1px dashed var(--border); padding-top:15px;"><button id="aiBtn" class="btn-secondary" style="width:100%; border-color:#818cf8; color:#4f46e5; background:#eef2ff;" onclick="askAI()">‚ú® Ask AI Consultant for Strategy</button><div id="aiResult" style="margin-top:15px; font-size:14px; line-height:1.6; color:#334155; display:none; background:white; padding:15px; border-radius:12px; border:1px solid #e2e8f0;"></div></div>`;
}

function generateTable(d){ const t = document.getElementById("table"); t.innerHTML = "<tr><th>Product</th><th>Profit</th><th>Margin</th><th>Status</th></tr>"; d.forEach(x => { t.innerHTML += `<tr><td><b>${x.name}</b><br><small style='color:#64748B'>Sold: ${x.qty}</small></td><td>‚Çπ${x.profit.toLocaleString()}</td><td>${(x.margin*100).toFixed(1)}%</td><td>${x.margin>0.3?"<span style='color:green'>Healthy</span>":"<span style='color:orange'>Review</span>"}</td></tr>`; }); }

// --- UPDATED CHART FUNCTION (Aesthetics + Labels) ---
function drawChart(type, labels, data, colors){ 
  if(chartInstance) chartInstance.destroy(); 
  const ctx = document.getElementById("chart").getContext('2d'); 
  
  const options = { 
      responsive: true, maintainAspectRatio: false, 
      plugins: { 
          legend: { display: type === 'pie', position: 'bottom' },
          datalabels: { // Labels on Chart Segments
              color: type === 'pie' ? 'white' : '#64748B',
              font: { weight: 'bold', size: 11 },
              formatter: (value) => '‚Çπ' + value.toLocaleString(undefined, {maximumFractionDigits:0}),
              anchor: type === 'pie' ? 'center' : 'end',
              align: type === 'pie' ? 'center' : 'top',
              offset: 4
          }
      } 
  };
  
  if (type === 'bar') options.scales = { y: { beginAtZero: true }, x: { grid: { display: false } } };

  chartInstance = new Chart(ctx, { 
      type: type, 
      data: { 
          labels: labels, 
          datasets: [{ label: 'Profit', data: data, backgroundColor: colors, borderRadius: 4, borderWidth: 0 }] 
      }, 
      options: options,
      plugins: [ChartDataLabels] // Activate plugin
  }); 
}

// --- UPDATED AI FUNCTION (Works for both modes) ---
async function askAI() {
    if(!isProUser || !userEmail) return alert("Please Login (Pro Feature)");
    const btn = document.getElementById("aiBtn"); const box = document.getElementById("aiResult");
    btn.innerHTML = "‚ú® Strategizing..."; btn.disabled = true; btn.classList.add("ai-thinking");
    
    // Construct payload based on Mode
    let aiPayload = {};
    
    if (currentMode === 'monthly') {
        if(!monthlyStats) return alert("Run analysis first.");
        const s = monthlyStats;
        // Format for existing AI Worker structure (sending summarized text)
        aiPayload = {
            email: userEmail,
            mode: 'monthly',
            summary: `Based on ${s.count} months average:\nAvg Monthly Sales: ‚Çπ${s.avgSales.toFixed(0)}, Avg Expenses: ‚Çπ${s.avgExp.toFixed(0)}, Avg Orders: ${s.avgOrders.toFixed(1)}, Gross Margin: ${s.margin.toFixed(1)}%.`
        };
    } else {
        const products = currentData.map(x => ({ name: x.name, cost: x.cost, sell: x.sell, qty: x.qty }));
        aiPayload = { email: userEmail, products: products, mode: 'product' };
    }

    try {
        const r = await fetch(workerURL + "/ai-analyze", { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify(aiPayload) });
        const d = await r.json(); btn.classList.remove("ai-thinking");
        if(d.ok) { btn.style.display = "none"; box.style.display = "block"; box.innerHTML = "<strong>ü§ñ AI Consultant Strategy:</strong><br><br>" + d.response.replace(/\n/g, "<br>").replace(/\*\*(.*?)\*\*/g, "<strong>$1</strong>"); } else { alert(d.error); btn.innerHTML = "‚ú® Retry"; btn.disabled = false; }
    } catch(e) { btn.classList.remove("ai-thinking"); alert("Error"); btn.disabled = false; }
}

function handleLoginClick() { const email = prompt("Please enter your email to login:"); if(email) verify(email); }
async function verify(inputEmail){
  const email = inputEmail || document.getElementById("emailInput").value; if(!email) return alert("Please enter email.");
  const loginBtn = document.getElementById("loginBtn"); if(loginBtn) loginBtn.innerText = "Checking...";
  try {
    const r = await fetch(workerURL+"/check?email="+email); const d = await r.json();
    if(d.valid) {
        isProUser = true; userEmail = email; localStorage.setItem("vizbix_email", email);
        document.getElementById("lockOverlay").style.display = "none"; document.getElementById("loginBtn").style.display = "none";
        
        let dateStr = "";
        if(d.expiry) { const date = new Date(parseInt(d.expiry)); dateStr = date.toLocaleDateString(undefined, {day:'numeric', month:'short', year:'numeric'}); }
        
        const headerEmail = document.getElementById("userEmailHeader");
        headerEmail.innerHTML = `<div>${email}</div><div style="font-size:10px; opacity:0.8; margin-top:2px;">Exp: ${dateStr}</div>`;
        headerEmail.style.display = "block";

        document.getElementById("drawerEmailDisplay").innerText = email;
        const drawerExpiry = document.getElementById("drawerExpiryDisplay");
        if(drawerExpiry) drawerExpiry.innerText = "Plan expires: " + dateStr;
        
        document.getElementById("drawerProfile").style.display = "block";
        document.getElementById("historyBtn").style.display = "inline-flex"; document.getElementById("saveCloudBtn").style.display = "flex";
        if(chartInstance) chartInstance.resize();
    } else { alert("Pro subscription not found."); if(loginBtn) loginBtn.innerText = "Login"; }
  } catch(e) { console.log(e); }
}

// --- UPDATED SAVE FUNCTION (Handles both modes) ---
async function saveToCloud() {
    if(!isProUser) return alert("Login required"); const btn = document.getElementById("saveCloudBtn");
    
    // Decide what data to save
    let dataToSave = [];
    if (currentMode === 'monthly') {
        dataToSave = scrapeRows(monthItems);
    } else {
        dataToSave = scrapeRows(items);
    }
    
    if(dataToSave.length === 0) return alert("Nothing to save!");

    btn.innerHTML = "<span style='animation:spin 1s linear infinite'>‚è≥</span>";
    try { 
        await fetch(workerURL + "/save", { 
            method: "POST", headers: { "Content-Type": "application/json" }, 
            body: JSON.stringify({ email: userEmail, data: dataToSave, mode: currentMode, date: new Date().toISOString() }) 
        }); 
        btn.innerHTML = "‚úÖ"; setTimeout(() => btn.innerHTML = "<span style='font-size:18px'>üíæ</span>", 1500); 
    } catch(e) { btn.innerHTML = "üíæ"; }
}

function toggleHistory(show) { document.getElementById("historyModal").style.display = show ? "flex" : "none"; if(show && userEmail) fetchHistory(); }
async function fetchHistory() {
    const list = document.getElementById("historyList"); list.innerHTML = "Loading...";
    try {
        const r = await fetch(workerURL + "/history?email=" + userEmail); const d = await r.json();
        if(d.length === 0) { list.innerHTML = "<p style='color:#64748B; text-align:center'>No history.</p>"; return; }
        list.innerHTML = "";
        d.forEach(item => {
            const dateStr = new Date(item.date).toLocaleDateString();
            const modeLabel = item.mode === 'monthly' ? 'Monthly' : 'Product';
            const div = document.createElement("div"); div.className = "history-item";
            div.innerHTML = `<div><div style="font-weight:600; font-size:14px;">${dateStr}</div><div style="font-size:12px; color:#64748B">${item.data.length} Rows ‚Ä¢ ${modeLabel}</div></div><button class="btn-secondary" style="font-size:11px; padding:6px 10px;">Load</button>`;
            div.onclick = () => loadHistoryItem(item.data, item.mode);
            list.appendChild(div);
        });
    } catch(e) { list.innerHTML = "Error fetching history."; }
}

function loadHistoryItem(data, savedMode) {
    // Switch to the correct mode first
    const targetMode = savedMode || 'product'; // Default to product if old data
    setMode(targetMode);
    
    const container = targetMode === 'monthly' ? monthItems : items;
    container.innerHTML = "";
    
    data.forEach(x => {
        // Handle legacy array format vs new object format
        if(Array.isArray(x)) createRow(container, x[0], x[1], x[2], x[3], targetMode==='monthly'); // Legacy
        else createRow(container, x.n, x.v1, x.v2, x.v3, targetMode==='monthly'); // New
    });
    
    toggleHistory(false); saveDraft(); analyze();
}

function pay(){
  const email = document.getElementById("emailInput").value;
  if(!email) return alert("Email required");
  
  const options = {
    key: KEY, // Your Public Key
    amount: PRICE, 
    currency: "INR", 
    name: "Vizbix Pro", 
    description: "30 Days Access",
    prefill: { email: email }, 
    theme: { color: "#0F172A" },
    handler: async function(response){ 
        // SECURITY UPDATE: Send Payment ID to Worker for verification
        const btn = document.querySelector("button[onclick='pay()']");
        const originalText = btn.innerText;
        btn.innerText = "Verifying Payment...";
        btn.disabled = true;

        try {
            const verifyReq = await fetch(workerURL + "/verify-payment", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    payment_id: response.razorpay_payment_id,
                    email: email
                })
            });

            const verifyData = await verifyReq.json();

            if (verifyData.ok) {
                alert("Payment Successful! Welcome to Pro.");
                verify(email); // Refresh UI
            } else {
                alert("Verification Failed: " + (verifyData.error || "Unknown error"));
                btn.innerText = originalText;
                btn.disabled = false;
            }
        } catch (e) {
            alert("Network error during verification. Please contact support.");
            btn.innerText = originalText;
            btn.disabled = false;
        }
    }
  };

  const rzp1 = new Razorpay(options);
  rzp1.open();
}

async function downloadPDF() {
  const { jsPDF } = window.jspdf;
  const element = document.getElementById("results");
  const btn = document.querySelector("button[onclick='downloadPDF()']");
  const originalText = btn.innerText;
  btn.innerText = "Generating...";
  const canvas = await html2canvas(element, { scale: 2, backgroundColor: "#ffffff", useCORS: true });
  const imgData = canvas.toDataURL('image/png');
  const pdf = new jsPDF('p', 'mm', 'a4');
  const imgWidth = 210; 
  const imgHeight = canvas.height * imgWidth / canvas.width;
  pdf.addImage(imgData, 'PNG', 0, 0, imgWidth, imgHeight);
  pdf.save('Vizbix-Profit-Report.pdf');
  btn.innerText = originalText;
}

const menuBtn = document.getElementById("menuBtn"), drawer = document.getElementById("drawer"), overlay = document.getElementById("drawerOverlay"), closeBtn = document.getElementById("drawerClose");
function openDrawer(){ drawer.classList.add("open"); overlay.classList.add("open"); document.body.style.overflow = "hidden"; }
function closeDrawer(){ drawer.classList.remove("open"); overlay.classList.remove("open"); document.body.style.overflow = ""; }
if(menuBtn) menuBtn.addEventListener("click", openDrawer); if(closeBtn) closeBtn.addEventListener("click", closeDrawer); if(overlay) overlay.addEventListener("click", closeDrawer);
document.addEventListener("keydown", (e) => { if(e.key === "Escape") closeDrawer(); });
</script>
</body>
</html>



