<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Vizbix – Profit Intelligence</title>

<script src="https://checkout.razorpay.com/v1/checkout.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">

<style>
:root {
  --bg: #F8FAFC;
  --surface: #FFFFFF;
  --primary: #0F172A;
  --accent: #3B82F6;
  --accent-glow: rgba(59, 130, 246, 0.15);
  --success: #10B981;
  --text-main: #1E293B;
  --text-muted: #64748B;
  --border: #E2E8F0;
  --radius: 16px;
  --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
  --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
}

* { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }
body { margin: 0; background-color: var(--bg); font-family: 'Plus Jakarta Sans', system-ui, sans-serif; color: var(--text-main); padding-bottom: 60px; }
main { max-width: 900px; margin: auto; padding: 24px; }

header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 40px; padding-bottom: 20px; border-bottom: 1px solid var(--border); }
.brand { font-size: 24px; font-weight: 800; letter-spacing: -0.5px; color: var(--primary); }
.brand span { color: var(--accent); }
.subtitle { font-size: 14px; color: var(--text-muted); font-weight: 500; }

.card { background: var(--surface); border-radius: var(--radius); padding: 24px; margin-bottom: 24px; box-shadow: var(--shadow-sm); border: 1px solid var(--border); }

.input-group { position: relative; margin-bottom: 20px; }
.input-label { display: block; font-size: 12px; font-weight: 700; color: var(--text-muted); margin-bottom: 6px; text-transform: uppercase; letter-spacing: 0.5px; }

input { width: 100%; padding: 12px 16px; border-radius: 10px; border: 1px solid var(--border); background: #F1F5F9; font-weight: 500; font-size: 14px; transition: all 0.2s; }
input:focus { background: #fff; border-color: var(--accent); box-shadow: 0 0 0 4px var(--accent-glow); }

.grid-header { display: grid; grid-template-columns: 2fr 1fr 1fr 1fr 40px; gap: 12px; padding: 0 10px 8px 10px; font-size: 12px; font-weight: 600; color: var(--text-muted); }
.grid-row { display: grid; grid-template-columns: 2fr 1fr 1fr 1fr 40px; gap: 12px; margin-bottom: 10px; align-items: center; }

@media(max-width:640px){
  .grid-header { display: none; }
  .grid-row { grid-template-columns: 1fr 1fr; gap: 8px; background: #f8fafc; padding: 10px; border-radius: 12px; border: 1px solid var(--border); }
  .grid-row input:first-child { grid-column: span 2; }
}

button { padding: 12px 20px; border-radius: 12px; font-weight: 600; font-size: 14px; cursor: pointer; border: none; transition: all 0.2s; display: inline-flex; align-items: center; justify-content: center; gap: 8px; }
.btn-primary { background: var(--primary); color: white; }
.btn-secondary { background: white; border: 1px solid var(--border); color: var(--text-main); }
.btn-ghost { background: transparent; color: var(--text-muted); padding: 8px; }
.btn-ghost:hover { color: #ef4444; background: #fef2f2; }

.kpi-container { display: flex; gap: 20px; margin-bottom: 24px; flex-wrap: wrap; }
.kpi-card { flex: 1; border: 1px solid var(--border); border-radius: 12px; padding: 16px; min-width: 140px; background: white; }
.kpi-label { font-size: 12px; font-weight: 600; color: var(--text-muted); }
.kpi-value { font-size: 24px; font-weight: 800; color: var(--primary); }

.locked-container { position: relative; overflow: hidden; }
.blur-overlay { position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(255, 255, 255, 0.4); backdrop-filter: blur(12px); z-index: 10; display: flex; align-items: center; justify-content: center; }
.lock-card { background: white; padding: 30px; border-radius: 20px; text-align: center; border: 1px solid var(--border); max-width: 320px; box-shadow: var(--shadow-lg); }
.premium-badge { background: var(--primary); color: white; padding: 4px 12px; border-radius: 20px; font-size: 10px; font-weight: 700; text-transform: uppercase; margin-bottom: 12px; display: inline-block; }

.history-item { display: flex; justify-content: space-between; align-items: center; padding: 12px; border-bottom: 1px solid var(--border); }
.insight-item { padding: 16px; border-radius: 12px; margin-bottom: 12px; font-size: 14px; }
.insight-green { background: #ECFDF5; color: #065F46; border: 1px solid #D1FAE5; }
.insight-orange { background: #FFF7ED; color: #9A3412; border: 1px solid #FFEDD5; }
table { width: 100%; border-collapse: separate; border-spacing: 0; margin-top: 20px; }
th { text-align: left; padding: 12px; border-bottom: 2px solid var(--border); font-size: 12px; color: var(--text-muted); }
td { padding: 12px; border-bottom: 1px solid var(--border); font-size: 14px; }
</style>
</head>
<body>

<main>
  <header>
    <div>
      <div class="brand">Vizbix<span>.</span></div>
      <div class="subtitle">E-commerce Intelligence Engine</div>
    </div>
    <div id="authArea" style="text-align:right">
        <button id="loginBtn" class="btn-secondary" style="padding: 8px 16px;" onclick="handleAuth()">Login / Sign Up</button>
        <div id="userProfile" style="display:none">
            <div id="userEmailDisplay" style="font-size:12px; font-weight:700;"></div>
            <div style="font-size:10px; color:var(--accent); margin-bottom:4px;" id="userStatus">Basic Plan</div>
            <button class="btn-ghost" style="padding:0; font-size:11px; color:red;" onclick="logout()">Logout</button>
        </div>
    </div>
  </header>

  <div class="card" id="historyCard" style="display:none">
    <div class="input-label">Cloud History</div>
    <div id="historyList"></div>
    <button class="btn-secondary" style="width:100%; margin-top:10px; font-size:12px;" onclick="saveToCloud()">Save Current Draft to Cloud</button>
  </div>

  <div class="card">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
      <div class="input-label">DATA SOURCE</div>
      <div class="input-label" style="color:var(--accent); cursor:pointer;" onclick="sample()">Use Demo Data</div>
    </div>
    <div class="grid-header">
      <div>PRODUCT NAME</div><div>SELL PRICE</div><div>COST PRICE</div><div>QTY SOLD</div><div></div>
    </div>
    <div id="items"></div>
    <div style="margin-top:16px; display:flex; gap:10px;">
      <button class="btn-secondary" style="width:100%" onclick="addRow()">+ Add Product</button>
      <button id="analyzeBtn" class="btn-primary" style="width:100%" onclick="analyze()">Generate Report →</button>
    </div>
  </div>

  <div id="results" style="display:none">
    <div class="kpi-container">
      <div class="kpi-card"><div class="kpi-label">TOTAL REVENUE</div><div class="kpi-value" id="dispRevenue">₹0</div></div>
      <div class="kpi-card"><div class="kpi-label">TOTAL COST</div><div class="kpi-value" id="dispCost" style="color:#64748B">₹0</div></div>
      <div class="kpi-card" style="border-color:var(--success); background:#f0fdf4;"><div class="kpi-label" style="color:#15803d">NET PROFIT</div><div class="kpi-value" id="dispProfit" style="color:#15803d">₹0</div></div>
    </div>

    <div class="card locked-container" id="proContainer">
      <div class="blur-overlay" id="lockOverlay">
        <div class="lock-card">
          <span class="premium-badge">Vizbix Pro</span>
          <h3 style="margin:0 0 10px 0;">Unlock Strategic Insights</h3>
          <p style="font-size:13px; color:#64748B; margin-bottom:20px;">Get visualization, margin analysis, and cloud saving.</p>
          <input id="emailInput" placeholder="Confirm your email" style="margin-bottom:10px; text-align:center;">
          <button class="btn-primary" style="width:100%" onclick="pay()">Unlock for ₹299</button>
          <button style="background:none; border:none; color:#64748B; font-size:11px; margin-top:10px; cursor:pointer; text-decoration:underline" onclick="verify()">Restore Purchase</button>
        </div>
      </div>

      <div id="proContent">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
          <h3 style="margin:0">Strategic Report</h3>
          <button class="btn-secondary" style="padding:6px 12px; font-size:12px;" onclick="downloadPDF()">↓ Export Report</button>
        </div>
        <div id="insights"></div>
        <div style="overflow-x:auto;"><table id="table"></table></div>
        <div style="height:300px; margin-top:30px;"><canvas id="chart"></canvas></div>
      </div>
    </div>
  </div>
</main>

<script>
const workerURL = window.location.origin;
const PRICE = 29900;
const KEY = "rzp_live_SAbBHVMbGMv2xo"; 
const items = document.getElementById("items");
let chartInstance, currentData = [], currentUser = null;

// --- INIT ---
window.addEventListener('DOMContentLoaded', async () => {
    const token = localStorage.getItem("vizbix_token");
    if(token) await checkAuth(token);
    
    const saved = localStorage.getItem("vizbix_draft");
    if(saved) {
        try {
            JSON.parse(saved).forEach(x => createRow(x.name, x.sell, x.cost, x.qty));
        } catch(e) { createRow(); createRow(); }
    } else {
        createRow(); createRow();
    }
});

// --- AUTH LOGIC ---
async function checkAuth(token) {
    try {
        const r = await fetch(`${workerURL}/me?token=${token}`);
        const d = await r.json();
        if(d.ok) {
            currentUser = d;
            document.getElementById("loginBtn").style.display = "none";
            document.getElementById("userProfile").style.display = "block";
            document.getElementById("userEmailDisplay").innerText = d.email;
            document.getElementById("emailInput").value = d.email;
            document.getElementById("historyCard").style.display = "block";
            if(d.valid) {
                unlock();
                document.getElementById("userStatus").innerText = "PRO PLAN ACTIVE";
            }
            loadHistory();
        }
    } catch(e) { console.error("Auth error"); }
}

async function handleAuth() {
    const email = prompt("Enter your email to Login or Sign Up:");
    if(!email) return;
    const r = await fetch(`${workerURL}/login?email=${email.toLowerCase()}`);
    const d = await r.json();
    if(d.ok) {
        localStorage.setItem("vizbix_token", d.token);
        location.reload();
    }
}

function logout() {
    localStorage.removeItem("vizbix_token");
    location.reload();
}

// --- HISTORY LOGIC ---
async function saveToCloud() {
    if(!currentUser) return alert("Login to save history");
    const data = getFormData();
    await fetch(`${workerURL}/history`, {
        method: "POST",
        body: JSON.stringify({ token: localStorage.getItem("vizbix_token"), data, timestamp: new Date().toLocaleString() })
    });
    alert("Saved!");
    loadHistory();
}

async function loadHistory() {
    const r = await fetch(`${workerURL}/history?token=${localStorage.getItem("vizbix_token")}`);
    const d = await r.json();
    if(d.history) {
        document.getElementById("historyList").innerHTML = d.history.map((h, i) => `
            <div class="history-item">
                <span style="font-size:12px;">${h.timestamp}</span>
                <button class="btn-secondary" style="padding:4px 8px; font-size:10px;" onclick="restoreHistory(${i})">Load</button>
            </div>
        `).join('');
    }
}

async function restoreHistory(index) {
    const r = await fetch(`${workerURL}/history?token=${localStorage.getItem("vizbix_token")}`);
    const d = await r.json();
    items.innerHTML = "";
    d.history[index].data.forEach(x => createRow(x.name, x.sell, x.cost, x.qty));
    saveDraft();
    analyze();
}

// --- CORE UTILS ---
function createRow(name="", sell="", cost="", qty=""){
  const d = document.createElement("div"); d.className = "grid-row";
  d.innerHTML = `<input type="text" placeholder="Product" value="${name}"><input type="number" placeholder="Sell" value="${sell}"><input type="number" placeholder="Cost" value="${cost}"><input type="number" placeholder="Qty" value="${qty}"><button class="btn-ghost" onclick="removeRow(this)">✕</button>`;
  items.appendChild(d);
}
function addRow(){ createRow(); saveDraft(); }
function removeRow(btn){ btn.parentElement.remove(); saveDraft(); }
items.addEventListener('input', saveDraft);

function getFormData() {
    return Array.from(document.querySelectorAll(".grid-row")).map(r => {
        const i = r.querySelectorAll("input");
        return { name: i[0].value, sell: i[1].value, cost: i[2].value, qty: i[3].value };
    });
}

function saveDraft() { localStorage.setItem("vizbix_draft", JSON.stringify(getFormData())); }

function sample(){
  items.innerHTML="";
  [["Wireless Earbuds", 2500, 1200, 140],["Smart Watch", 4500, 2800, 85],["Laptop Stand", 1200, 600, 120]].forEach(x => createRow(x[0], x[1], x[2], x[3]));
  saveDraft(); analyze(); 
}

function analyze(){
  let data = [], rev=0, cos=0, pro=0;
  document.querySelectorAll(".grid-row").forEach(r => {
    const i = r.querySelectorAll("input");
    const name = i[0].value || "Product", s = +i[1].value || 0, c = +i[2].value || 0, q = +i[3].value || 0;
    if(s===0 && c===0) return;
    const r_val = s*q, c_val = c*q, p_val = r_val-c_val;
    rev+=r_val; cos+=c_val; pro+=p_val;
    data.push({name, s, c, q, profit:p_val, margin: s>0 ? (s-c)/s : 0});
  });
  if(!data.length) return;
  document.getElementById("results").style.display = "block";
  document.getElementById("dispRevenue").innerText = "₹" + rev.toLocaleString();
  document.getElementById("dispCost").innerText = "₹" + cos.toLocaleString();
  document.getElementById("dispProfit").innerText = "₹" + pro.toLocaleString();
  generateTable(data); generateChart(data); generateInsights(data);
}

function generateInsights(d){
    const best = [...d].sort((a,b)=>b.profit - a.profit)[0];
    document.getElementById("insights").innerHTML = `<div class="insight-item insight-green"><strong>★ Star:</strong> ${best.name} is your top earner.</div>`;
}

function generateTable(d){
  let h = "<tr><th>Product</th><th>Profit</th><th>Margin</th></tr>";
  d.forEach(x => h += `<tr><td>${x.name}</td><td>₹${x.profit.toLocaleString()}</td><td>${(x.margin*100).toFixed(1)}%</td></tr>`);
  document.getElementById("table").innerHTML = h;
}

function generateChart(d){
  if(chartInstance) chartInstance.destroy();
  chartInstance = new Chart(document.getElementById("chart"), {
    type: 'bar',
    data: { labels: d.map(x=>x.name), datasets: [{ label: 'Profit', data: d.map(x=>x.profit), backgroundColor: '#0F172A' }] },
    options: { maintainAspectRatio: false }
  });
}

function unlock(){ document.getElementById("lockOverlay").style.display = "none"; }
async function verify(){
  const e = document.getElementById("emailInput").value;
  const r = await fetch(workerURL+"/check?email="+e);
  const d = await r.json();
  if(d.valid) unlock(); else alert("No subscription found.");
}
function pay(){
  new Razorpay({ key: KEY, amount: PRICE, currency: "INR", name: "Vizbix Pro", prefill: { email: document.getElementById("emailInput").value }, handler: verify }).open();
}
function downloadPDF(){ const { jsPDF } = window.jspdf; const doc = new jsPDF(); doc.text("Vizbix Report", 20, 20); doc.save("report.pdf"); }
</script>
</body>
</html>
