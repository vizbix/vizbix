<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0"/>
<title>Vizbix – Profit Intelligence</title>

<script src="https://checkout.razorpay.com/v1/checkout.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">

<style>
:root {
  --bg: #F8FAFC;
  --surface: #FFFFFF;
  --primary: #0F172A;
  --accent: #3B82F6;
  --accent-glow: rgba(59, 130, 246, 0.2);
  --success: #10B981;
  --danger: #EF4444;
  --text-main: #1E293B;
  --text-muted: #64748B;
  --border: #E2E8F0;
  --radius: 16px;
  --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
  --shadow-lg: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
}

* { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }

body {
  margin: 0;
  background-color: var(--bg);
  background-image: 
    radial-gradient(at 0% 0%, hsla(253,16%,7%,0) 0, transparent 50%), 
    radial-gradient(at 50% 0%, hsla(225,39%,30%,0.05) 0, transparent 50%), 
    radial-gradient(at 100% 0%, hsla(339,49%,30%,0) 0, transparent 50%);
  font-family: 'Plus Jakarta Sans', system-ui, sans-serif;
  color: var(--text-main);
  padding-bottom: 80px;
}

main { max-width: 900px; margin: auto; padding: 20px; }

/* --- Header --- */
header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 30px;
  padding: 16px 0;
  position: sticky;
  top: 0;
  z-index: 50;
  background: rgba(248, 250, 252, 0.8);
  backdrop-filter: blur(8px);
  border-bottom: 1px solid transparent;
  transition: border-color 0.3s;
}
header.scrolled { border-bottom-color: var(--border); }

.brand { font-size: 26px; font-weight: 800; letter-spacing: -0.5px; color: var(--primary); display: flex; align-items: center; gap: 8px; }
.brand span { color: var(--accent); }
.brand-sub { display: flex; flex-direction: column; }
.status-badge {
  font-size: 11px; font-weight: 600; background: #E2E8F0; color: var(--text-muted);
  padding: 4px 10px; border-radius: 20px; display: flex; align-items: center; gap: 6px;
}
.status-dot { width: 6px; height: 6px; background: var(--text-muted); border-radius: 50%; }
.status-badge.saving .status-dot { background: var(--accent); animation: pulse 1s infinite; }
@keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.4; } 100% { opacity: 1; } }

/* --- Cards --- */
.card {
  background: var(--surface);
  border-radius: var(--radius);
  padding: 24px;
  margin-bottom: 24px;
  box-shadow: var(--shadow-sm);
  border: 1px solid var(--border);
}

/* --- Input Grid --- */
.grid-header {
  display: grid;
  grid-template-columns: 3fr 1.5fr 1.5fr 1fr 40px;
  gap: 16px;
  padding: 0 16px 12px 16px;
  font-size: 11px;
  font-weight: 700;
  color: var(--text-muted);
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.grid-row {
  display: grid;
  grid-template-columns: 3fr 1.5fr 1.5fr 1fr 40px;
  gap: 16px;
  align-items: center;
  padding: 8px 0;
  border-bottom: 1px solid transparent;
}
.grid-row:hover { background: #f8fafc; border-radius: 8px; }

/* Input Styling with Icons */
.input-wrapper { position: relative; width: 100%; }
.input-icon {
  position: absolute;
  left: 12px;
  top: 50%;
  transform: translateY(-50%);
  color: var(--text-muted);
  font-size: 14px;
  pointer-events: none;
}
input {
  width: 100%;
  padding: 12px 12px 12px 12px;
  border-radius: 10px;
  border: 1px solid var(--border);
  background: #fff;
  font-family: inherit;
  font-weight: 500;
  font-size: 14px;
  color: var(--primary);
  transition: all 0.2s;
  -webkit-appearance: none;
}
.has-icon input { padding-left: 28px; } /* Space for icon */

input:focus { border-color: var(--accent); box-shadow: 0 0 0 3px var(--accent-glow); outline: none; }
input::placeholder { color: #cbd5e1; font-weight: 400; }

/* Mobile Grid Transformation */
@media(max-width: 640px){
  .grid-header { display: none; }
  .grid-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 12px;
    background: #fff;
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 16px;
    margin-bottom: 12px;
    box-shadow: var(--shadow-sm);
    position: relative;
  }
  .grid-row > .input-wrapper:nth-child(1) { grid-column: span 2; }
  .grid-row > button {
    position: absolute; top: 8px; right: 8px;
    background: #fee2e2; color: var(--danger);
    width: 28px; height: 28px; border-radius: 50%;
    display: flex; align-items: center; justify-content: center;
  }
  .input-wrapper::before {
    content: attr(data-label);
    display: block; font-size: 10px; font-weight: 700;
    color: var(--text-muted); margin-bottom: 4px; text-transform: uppercase;
  }
}

/* --- Buttons --- */
.action-bar { display: grid; grid-template-columns: 1fr 2fr; gap: 12px; margin-top: 24px; }
@media(max-width:640px){ .action-bar { grid-template-columns: 1fr; } }

button {
  padding: 14px 20px;
  border-radius: 12px;
  font-weight: 600;
  font-size: 15px;
  cursor: pointer;
  border: none;
  transition: all 0.2s;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
  font-family: inherit;
}

.btn-primary { background: var(--primary); color: white; box-shadow: 0 4px 12px rgba(15, 23, 42, 0.2); }
.btn-primary:active { transform: scale(0.98); }
.btn-primary:hover { background: #1e293b; box-shadow: 0 6px 16px rgba(15, 23, 42, 0.3); transform: translateY(-1px); }

.btn-secondary { background: white; border: 1px solid var(--border); color: var(--text-main); }
.btn-secondary:hover { background: #f8fafc; border-color: #cbd5e1; }

.btn-ghost { background: transparent; color: var(--text-muted); padding: 8px; border-radius: 8px; }
.btn-ghost:hover { color: var(--danger); background: #fef2f2; }

/* --- Results Section --- */
.kpi-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 16px; margin-bottom: 24px; }

.kpi-card {
  background: white; border: 1px solid var(--border); border-radius: 16px; padding: 20px; position: relative; overflow: hidden;
}
.kpi-icon { width: 32px; height: 32px; border-radius: 8px; background: #F1F5F9; color: var(--primary); display: flex; align-items: center; justify-content: center; margin-bottom: 12px; }
.kpi-label { font-size: 11px; font-weight: 700; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 4px; }
.kpi-value { font-size: 24px; font-weight: 800; color: var(--primary); letter-spacing: -0.5px; }

.kpi-net { border-color: #D1FAE5; background: #F0FDF4; }
.kpi-net .kpi-icon { background: #DCFCE7; color: #166534; }
.kpi-net .kpi-value { color: #15803d; }

/* --- Locked / Pro Section --- */
.locked-container { position: relative; min-height: 400px; padding: 0; border: none; background: transparent; box-shadow: none;}
.blur-overlay {
  position: absolute; top: 0; left: 0; right: 0; bottom: 0;
  background: rgba(255, 255, 255, 0.4); backdrop-filter: blur(16px); -webkit-backdrop-filter: blur(16px);
  z-index: 10; display: flex; flex-direction: column; align-items: center; justify-content: center;
  border-radius: var(--radius); border: 1px solid rgba(255,255,255,0.6);
}

.lock-card {
  background: white; padding: 32px; border-radius: 24px; text-align: center;
  box-shadow: var(--shadow-lg); border: 1px solid var(--border); max-width: 340px; width: 90%;
  animation: float 6s ease-in-out infinite;
}
@keyframes float { 0% {transform: translateY(0px);} 50% {transform: translateY(-10px);} 100% {transform: translateY(0px);} }
.premium-badge {
  background: linear-gradient(135deg, #0F172A 0%, #334155 100%); color: white; padding: 6px 14px;
  border-radius: 20px; font-size: 11px; font-weight: 700; text-transform: uppercase;
  margin-bottom: 16px; display: inline-block; box-shadow: 0 4px 10px rgba(15, 23, 42, 0.2);
}

/* --- Insights & Table --- */
.insight-item { display: flex; align-items: flex-start; gap: 16px; padding: 16px; border-radius: 12px; margin-bottom: 12px; font-size: 14px; line-height: 1.5; }
.insight-green { background: #ECFDF5; color: #065F46; border: 1px solid #A7F3D0; }
.insight-blue { background: #EFF6FF; color: #1E40AF; border: 1px solid #BFDBFE; }
.insight-orange { background: #FFF7ED; color: #9A3412; border: 1px solid #FED7AA; }

.table-wrapper { overflow-x: auto; border-radius: 12px; border: 1px solid var(--border); margin-top: 20px; }
table { width: 100%; border-collapse: collapse; background: white; min-width: 500px; }
th { text-align: left; padding: 14px 16px; background: #F8FAFC; border-bottom: 1px solid var(--border); font-size: 11px; font-weight: 700; color: var(--text-muted); text-transform: uppercase; }
td { padding: 14px 16px; border-bottom: 1px solid var(--border); font-size: 14px; color: var(--text-main); }
tr:last-child td { border-bottom: none; }
</style>
</head>

<body>

<main>
  <header id="mainHeader">
    <div class="brand">
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="3" width="20" height="14" rx="2" ry="2"></rect><line x1="8" y1="21" x2="16" y2="21"></line><line x1="12" y1="17" x2="12" y2="21"></line></svg>
      <div class="brand-sub">Vizbix<span>.</span></div>
    </div>
    <div class="status-badge" id="saveStatus">
      <div class="status-dot"></div> <span id="saveText">Ready</span>
    </div>
  </header>

  <div class="card">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
      <h3 style="margin:0; font-size:16px;">Product Data</h3>
      <button class="btn-ghost" style="font-size:13px; color:var(--accent);" onclick="sample()">Load Demo Data</button>
    </div>
    
    <div class="grid-header">
      <div>Product Name</div>
      <div>Sell Price</div>
      <div>Cost Price</div>
      <div>Qty Sold</div>
      <div></div>
    </div>

    <div id="items"></div>

    <div class="action-bar">
      <button class="btn-secondary" onclick="addRow()">+ Add Product</button>
      <button id="analyzeBtn" class="btn-primary" onclick="analyze()">Generate Report →</button>
    </div>
  </div>

  <div id="results" style="display:none">
    
    <h3 style="margin: 0 0 16px 0;">Executive Summary</h3>
    <div class="kpi-container">
      <div class="kpi-card">
        <div class="kpi-icon">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="5" width="20" height="14" rx="2"/><line x1="12" y1="12" x2="12.01" y2="12" stroke-width="4"/></svg>
        </div>
        <div class="kpi-label">Total Revenue</div>
        <div class="kpi-value" id="dispRevenue">₹0</div>
      </div>
      <div class="kpi-card">
        <div class="kpi-icon" style="color:#ef4444">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20.24 12.24a6 6 0 0 0-8.49-8.49L5 10.5V19h8.5z"></path><line x1="16" y1="8" x2="2" y2="22"></line><line x1="17.5" y1="15" x2="9" y2="15"></line></svg>
        </div>
        <div class="kpi-label">Total Cost</div>
        <div class="kpi-value" id="dispCost" style="color:var(--text-muted)">₹0</div>
      </div>
      <div class="kpi-card kpi-net">
        <div class="kpi-icon">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"></polyline><polyline points="17 6 23 6 23 12"></polyline></svg>
        </div>
        <div class="kpi-label">Net Profit</div>
        <div class="kpi-value" id="dispProfit">₹0</div>
      </div>
    </div>

    <div class="card locked-container" id="proContainer">
      
      <div class="blur-overlay" id="lockOverlay">
        <div class="lock-card">
          <span class="premium-badge">Vizbix Pro</span>
          <h2 style="margin:0 0 8px 0; font-size: 20px;">Unlock Intelligence</h2>
          <p style="font-size:14px; color:#64748B; margin-bottom:24px; line-height: 1.5;">
            Reveal margin breakdowns, visualizations, and AI-driven pricing strategies.
          </p>
          <div class="input-wrapper" style="margin-bottom:12px;">
            <input id="emailInput" placeholder="Enter your email" style="text-align:center;">
          </div>
          <button class="btn-primary" style="width:100%" onclick="pay()">Unlock for ₹299</button>
          <button style="background:none; border:none; color:#64748B; font-size:12px; margin-top:12px; cursor:pointer; text-decoration:underline" onclick="verify()">Restore Purchase</button>
        </div>
      </div>

      <div id="proContent" style="background:white; border-radius:16px; border:1px solid var(--border); padding:24px;">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:24px; flex-wrap:wrap; gap:10px;">
          <h3 style="margin:0">Strategy Report</h3>
          <button class="btn-secondary" style="padding:8px 14px; font-size:13px;" onclick="downloadPDF()">Export PDF</button>
        </div>

        <h4 style="margin:0 0 16px 0; color:var(--text-muted); font-size:12px; text-transform:uppercase;">AI Recommendations</h4>
        <div id="insights"></div>

        <h4 style="margin:40px 0 16px 0; color:var(--text-muted); font-size:12px; text-transform:uppercase;">Profit Distribution</h4>
        <div style="height:320px; width:100%; position:relative;">
          <canvas id="chart"></canvas>
        </div>

        <h4 style="margin:40px 0 16px 0; color:var(--text-muted); font-size:12px; text-transform:uppercase;">Detailed Breakdown</h4>
        <div class="table-wrapper">
          <table id="table"></table>
        </div>
      </div>
    </div>
  </div>
</main>

<script>
const workerURL = window.location.origin;
const PRICE = 29900;
const KEY = "rzp_live_SAbBHVMbGMv2xo"; 

const items = document.getElementById("items");
let chartInstance;
let currentData = [];

window.addEventListener('scroll', () => {
  const header = document.getElementById('mainHeader');
  if(window.scrollY > 10) header.classList.add('scrolled');
  else header.classList.remove('scrolled');
});

// --- Auto-Load ---
window.addEventListener('DOMContentLoaded', () => {
    const saved = localStorage.getItem("vizbix_draft");
    if(saved) {
        try {
            const data = JSON.parse(saved);
            if (data.length > 0) {
                items.innerHTML = "";
                data.forEach(x => createRow(x.name, x.sell, x.cost, x.qty));
            } else {
                initEmpty();
            }
        } catch (e) { initEmpty(); }
    } else {
        initEmpty();
    }
});

function initEmpty() {
    createRow(); createRow(); createRow(); 
}

// --- Auto-Save ---
items.addEventListener('input', () => {
    saveDraft();
});

function saveDraft() {
    const rawData = [];
    document.querySelectorAll(".grid-row").forEach(r => {
        const i = r.querySelectorAll("input");
        rawData.push({
            name: i[0].value,
            sell: i[1].value,
            cost: i[2].value,
            qty: i[3].value
        });
    });
    localStorage.setItem("vizbix_draft", JSON.stringify(rawData));
    
    const badge = document.getElementById("saveStatus");
    const text = document.getElementById("saveText");
    badge.classList.add("saving");
    text.innerText = "Saving...";
    setTimeout(() => {
        badge.classList.remove("saving");
        text.innerText = "Saved";
    }, 800);
}

/* ---------- Create Row (UPDATED: Starts Empty) ---------- */
function createRow(name="", sell="", cost="", qty=""){
  const d = document.createElement("div");
  d.className = "grid-row";
  
  // Logic to ensure fields start truly empty if no value is passed
  // We don't want value="0"
  
  d.innerHTML = `
    <div class="input-wrapper" data-label="Product">
        <input type="text" placeholder="e.g. Wireless Buds" value="${name}">
    </div>
    
    <div class="input-wrapper has-icon" data-label="Sell Price">
        <span class="input-icon">₹</span>
        <input type="number" placeholder="0.00" value="${sell}">
    </div>

    <div class="input-wrapper has-icon" data-label="Cost Price">
        <span class="input-icon">₹</span>
        <input type="number" placeholder="0.00" value="${cost}">
    </div>

    <div class="input-wrapper has-icon" data-label="Quantity">
        <span class="input-icon">#</span>
        <input type="number" placeholder="0" value="${qty}">
    </div>

    <button class="btn-ghost" onclick="removeRow(this)" title="Remove">✕</button>
  `;
  items.appendChild(d);
}

function addRow(){
    // Call with empty arguments so no "0" appears in value
    createRow("", "", "", ""); 
    saveDraft();
}

function removeRow(btn){
    if(document.querySelectorAll('.grid-row').length > 1) {
        btn.parentElement.remove();
        saveDraft();
    } else {
        const inputs = btn.parentElement.querySelectorAll('input');
        inputs.forEach(i => i.value = '');
        saveDraft();
    }
}

function sample(){
  items.innerHTML="";
  [
    ["Wireless Earbuds", 2500, 1200, 140],
    ["Smart Watch", 4500, 2800, 85],
    ["USB-C Cable", 499, 150, 400],
    ["Laptop Stand", 1200, 600, 120]
  ].forEach(x => createRow(x[0], x[1], x[2], x[3]));
  saveDraft();
  analyze(); 
}

function analyze(){
  let data = [];
  let totalRevenue = 0;
  let totalCost = 0;
  let totalProfit = 0;

  document.querySelectorAll(".grid-row").forEach(r => {
    const i = r.querySelectorAll("input");
    const name = i[0].value || "Unnamed Product";
    const sell = +i[1].value || 0;
    const cost = +i[2].value || 0;
    const qty = +i[3].value || 0;

    if(sell === 0 && cost === 0) return; 

    const revenue = sell * qty;
    const productCost = cost * qty;
    const profit = revenue - productCost;
    const margin = sell > 0 ? ((sell - cost) / sell) : 0;

    totalRevenue += revenue;
    totalCost += productCost;
    totalProfit += profit;

    data.push({name, sell, cost, qty, profit, margin});
  });

  if(data.length === 0) return alert("Please enter at least one product price.");

  currentData = data;
  document.getElementById("results").style.display = "block";
  setTimeout(() => {
    document.getElementById("results").scrollIntoView({behavior: "smooth", block: "start"});
  }, 100);

  animateValue("dispRevenue", totalRevenue);
  animateValue("dispCost", totalCost);
  animateValue("dispProfit", totalProfit);

  generateTable(data);
  generateChart(data);
  generateInsights(data);
}

function animateValue(id, end) {
    const obj = document.getElementById(id);
    const start = 0;
    const duration = 1000;
    let startTimestamp = null;
    const step = (timestamp) => {
        if (!startTimestamp) startTimestamp = timestamp;
        const progress = Math.min((timestamp - startTimestamp) / duration, 1);
        obj.innerHTML = "₹" + Math.floor(progress * (end - start) + start).toLocaleString();
        if (progress < 1) window.requestAnimationFrame(step);
    };
    window.requestAnimationFrame(step);
}

function generateInsights(d){
  const insightsDiv = document.getElementById("insights");
  let html = "";
  const best = [...d].sort((a,b)=>b.profit - a.profit)[0];
  if(best) {
      html += `<div class="insight-item insight-green">
        <div><strong>★ Star Product:</strong> ${best.name} is your profit driver.</div>
      </div>`;
  }
  d.forEach(x => {
    if(x.margin < 0.20 && x.qty > 10) {
      const suggestedPrice = x.cost / 0.70; 
      html += `<div class="insight-item insight-orange">
        <div><strong>⚠ Margin Alert:</strong> ${x.name} has low margin (${(x.margin*100).toFixed(0)}%). Aim for ₹${Math.round(suggestedPrice)}.</div>
      </div>`;
    }
  });
  if(html === "") html = `<div class="insight-item insight-blue"><div>✓ All products have healthy margins.</div></div>`;
  insightsDiv.innerHTML = html;
}

function generateTable(d){
  const table = document.getElementById("table");
  table.innerHTML = "<tr><th>Product</th><th>Profit</th><th>Margin</th><th>Health</th></tr>";
  d.forEach(x => {
    let status = x.margin > 0.3 ? "<span style='color:var(--success);font-weight:700'>Healthy</span>" : "<span style='color:orange;font-weight:700'>Low</span>";
    table.innerHTML += `<tr>
      <td><div style="font-weight:600">${x.name}</div><div style="font-size:11px;color:#94a3b8">Sold: ${x.qty}</div></td>
      <td style="font-weight:600">₹${x.profit.toLocaleString()}</td>
      <td>${(x.margin*100).toFixed(1)}%</td>
      <td>${status}</td>
    </tr>`;
  });
}

function generateChart(d){
  if(chartInstance) chartInstance.destroy();
  const ctx = document.getElementById("chart").getContext('2d');
  chartInstance = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: d.map(x => x.name),
      datasets: [{
        label: 'Net Profit (₹)',
        data: d.map(x => x.profit),
        backgroundColor: '#0F172A',
        borderRadius: 8
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: { legend: {display: false} },
      scales: {
        y: { beginAtZero: true, grid: { color: '#f1f5f9', borderDash: [5, 5] } },
        x: { grid: { display: false } }
      }
    }
  });
}

function unlock(){
  document.getElementById("lockOverlay").style.opacity = "0";
  setTimeout(() => { 
      document.getElementById("lockOverlay").style.display = "none";
      if(chartInstance) chartInstance.resize(); 
  }, 400);
}

async function verify(){
  const email = document.getElementById("emailInput").value;
  if(!email) return alert("Please enter email.");
  document.querySelector(".btn-primary").innerText = "Verifying...";
  try {
    const r = await fetch(workerURL+"/check?email="+email);
    const d = await r.json();
    if(d.valid) unlock();
    else alert("Pro subscription not found.");
  } catch(e) { unlock(); }
}

function pay(){
  const email = document.getElementById("emailInput").value;
  if(!email) return alert("Enter email first.");
  new Razorpay({
    key: KEY, amount: PRICE, currency: "INR", name: "Vizbix Pro",
    prefill: { email: email }, theme: { color: "#0F172A" },
    handler: function(response){ verify(); }
  }).open();
}

function downloadPDF(){
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();
  doc.setFontSize(20); doc.text("Vizbix Intelligence Report", 20, 20);
  doc.setFontSize(12); doc.text("Generated on: " + new Date().toLocaleDateString(), 20, 30);
  if(chartInstance){ doc.addImage(chartInstance.toBase64Image(), "PNG", 20, 40, 170, 90); }
  doc.save("vizbix-report.pdf");
}
</script>
</body>
</html>
